apiVersion: v1
kind: Service
metadata:
  annotations:
    kompose.cmd: C:\Users\noasgnil\go\bin\kompose.exe convert -d -f .\docker-stack-beta.yml
    kompose.version: 1.16.0 (HEAD)
    service.beta.kubernetes.io/azure-load-balancer-internal: "true"
  labels:
    fint.role: consumer
    fint.stack: utdanning-elev
  name: consumer-utdanning-elev
spec:
  ports:
  - name: "8080"
    port: 8080
  selector:
    fint.role: consumer
    fint.stack: utdanning-elev
  type: LoadBalancer
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    kompose.cmd: C:\Users\noasgnil\go\bin\kompose.exe convert -d -f .\docker-stack-beta.yml
    kompose.version: 1.16.0 (HEAD)
    service.beta.kubernetes.io/azure-load-balancer-internal: "true"
  labels:
    fint.role: provider
    fint.stack: utdanning-elev
  name: provider-utdanning-elev
spec:
  ports:
  - name: "8080"
    port: 8080
  selector:
    fint.role: provider
    fint.stack: utdanning-elev
  type: LoadBalancer
---
apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    kompose.cmd: C:\Users\noasgnil\go\bin\kompose.exe convert -d -f .\docker-stack-beta.yml
    kompose.version: 1.16.0 (HEAD)
  labels:
    fint.stack: utdanning-elev
    fint.role: consumer
  name: consumer-utdanning-elev
spec:
  replicas: 1
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  selector:
    matchLabels:
      fint.stack: utdanning-elev
      fint.role: consumer
  template:
    metadata:
      labels:
        fint.stack: utdanning-elev
        fint.role: consumer
    spec:
      restartPolicy: Always
      containers:
        - name: consumer-utdanning-elev
          image: fintlabs.azurecr.io/consumer-utdanning-elev:1.1.0
          ports:
            - containerPort: 8080
          readinessProbe:
            initialDelaySeconds: 60
            timeoutSeconds: 30
            httpGet:
              port: 8080
              path: /utdanning/elev/health
          resources:
            limits:
              memory: "10Gi"
              cpu: "750m"
          env:
            - name: TZ
              value: Europe/Oslo
            - name: JAVA_TOOL_OPTIONS
              value: "-XX:+ExitOnOutOfMemoryError -Xmx8G -verbose:gc"
            - name: fint.audit.mongo.databasename
              value: fint-audit-beta
            - name: fint.audit.mongo.connection-string
              valueFrom:
                secretKeyRef:
                  name: fint-audit
                  key: mongodb
            - name: fint.cache.manager
              value: default
            - name: fint.events.orgIds
              value: health.fintlabs.no
            - name: fint.hazelcast.kubernetes.enabled
              value: "true"
            - name: fint.hazelcast.kubernetes.namespace
              value: default
            - name: fint.hazelcast.kubernetes.labelName
              value: fint.stack
            - name: fint.hazelcast.kubernetes.labelValue
              value: utdanning-elev
            - name: fint.relations.default-base-url
              value: https://beta.felleskomponent.no
            - name: server.context-path
              value: /utdanning/elev
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels: {fint.stack: utdanning-elev, fint.role: provider}
  name: provider-utdanning-elev
spec:
  replicas: 1
  selector:
    matchLabels: {fint.stack: utdanning-elev, fint.role: provider}
  strategy:
    type: RollingUpdate
    rollingUpdate: {maxSurge: 1, maxUnavailable: 0}
  template:
    metadata:
      labels: {fint.stack: utdanning-elev, fint.role: provider}
    spec:
      containers:
        - env:
            - {name: TZ, value: Europe/Oslo}
            - {name: JAVA_TOOL_OPTIONS, value: '-XX:+ExitOnOutOfMemoryError -Xmx3G -verbose:gc'}
            - {name: fint.audit.mongo.databasename, value: fint-audit-beta}
            - name: fint.audit.mongo.connection-string
              valueFrom:
                secretKeyRef: {key: mongodb, name: fint-audit}
            - {name: fint.events.orgIds, value: health.fintlabs.no}
            - {name: fint.hazelcast.kubernetes.enabled, value: 'true'}
            - {name: fint.hazelcast.kubernetes.namespace, value: default}
            - {name: fint.hazelcast.kubernetes.labelName, value: fint.stack}
            - {name: fint.hazelcast.kubernetes.labelValue, value: utdanning-elev}
            - {name: fint.provider.max-number-of-emitters, value: '5'}
            - {name: server.context-path, value: /utdanning/elev/provider}
            - {name: server.tomcat.max-threads, value: '400'}
            - {name: server.tomcat.max-connections, value: '20000'}
            - {name: fint.provider.assets.endpoint, value: 'https://admin.fintlabs.no/api/components/assets/utdanning_elev'}
          image: fintlabs.azurecr.io/provider:2.1.0
          name: provider-utdanning-elev
          ports:
            - {containerPort: 8080}
          readinessProbe:
            httpGet: {path: /utdanning/elev/provider/health, port: 8080}
            initialDelaySeconds: 60
            timeoutSeconds: 5
          resources:
            limits: {memory: 4Gi, cpu: '2'}
            requests: {memory: 3Gi, cpu: 250m}
      restartPolicy: Always
